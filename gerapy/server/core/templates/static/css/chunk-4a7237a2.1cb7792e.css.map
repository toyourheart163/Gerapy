{"version":3,"sources":["webpack:///src/views/client/src/views/client/Schedule.vue","chunk-4a7237a2.1cb7792e.css"],"names":[],"mappings":"AAyRA,2BACA,iBCvRA","file":"chunk-4a7237a2.1cb7792e.css","sourcesContent":["<template>\n\t<div>\n\t\t<div class=\"panel\" v-for=\"project in projects\" :key=\"project\">\n\t\t\t<panel-title :title=\"project\">\n\t\t\t</panel-title>\n\t\t\t<div class=\"panel-body\" v-loading=\"projectsLoading\">\n\t\t\t\t<el-table\n\t\t\t\t\t:data=\"spiders[project]\"\n\t\t\t\t\tv-loading=\"spidersLoading[project]\"\n\t\t\t\t\t:style=\"{width: '100%'}\">\n\t\t\t\t\t<el-table-column\n\t\t\t\t\t\tprop=\"id\"\n\t\t\t\t\t\t:label=\"$lang.columns.id\"\n\t\t\t\t\t\twidth=\"200\">\n\t\t\t\t\t</el-table-column>\n\t\t\t\t\t<el-table-column\n\t\t\t\t\t\tprop=\"name\"\n\t\t\t\t\t\t:label=\"$lang.columns.name\"\n\t\t\t\t\t\twidth=\"400\">\n\t\t\t\t\t</el-table-column>\n\t\t\t\t\t<el-table-column\n\t\t\t\t\t\t:label=\"$lang.columns.operations\">\n\t\t\t\t\t\t<template slot-scope=\"props\">\n\t\t\t\t\t\t\t<el-button type=\"success\" size=\"mini\" @click=\"onStartSpider(project, props.row.name)\">\n\t\t\t\t\t\t\t\t<i class=\"fa fa-caret-right\"></i>\n\t\t\t\t\t\t\t\t{{ $lang.buttons.run }}\n\t\t\t\t\t\t\t</el-button>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t</el-table-column>\n\t\t\t\t</el-table>\n\t\t\t\t<el-collapse accordion @change=\"getLog\">\n\t\t\t\t\t<el-collapse-item v-for=\"job in jobs[project]\" :name=\"job.id\" :key=\"job.id\">\n\t\t\t\t\t\t<template slot=\"title\">\n\t\t\t\t\t\t\t<span v-if=\"job.spider\" class=\"m-l-xs\" :style=\"{minWidth: '120px'}\">\n\t\t\t\t\t\t\t\t<i class=\"fa fa-bug\"></i>\n\t\t\t\t\t\t\t\t{{ $lang.columns.spider }}:\n\t\t\t\t\t\t\t\t{{ job.spider }}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t<span v-if=\"job.spider\" class=\"m-l-md\" :style=\"{minWidth: '290px'}\">\n\t\t\t\t\t\t\t\t<i class=\"fa fa-key\"></i>\n\t\t\t\t\t\t\t\t{{ $lang.columns.jobID }}:\n\t\t\t\t\t\t\t\t{{ job.id }}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t<span v-if=\"job.start_time\" class=\"m-l-md\" :style=\"{minWidth: '190px'}\">\n\t\t\t\t\t\t\t\t<i class=\"el-icon-time\"></i>\n\t\t\t\t\t\t\t\t{{ $lang.columns.startTime }}:\n\t\t\t\t\t\t\t\t{{ job.start_time.substring(0, 16) }}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t<span v-if=\"job.end_time\" class=\"m-l-md\" :style=\"{minWidth: '190px'}\">\n\t\t\t\t\t\t\t\t<i class=\"el-icon-time\"></i>\n\t\t\t\t\t\t\t\t{{ $lang.columns.endTime }}:\n\t\t\t\t\t\t\t\t{{ job.end_time.substring(0, 16) }}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t<span class=\"m-l-md\">\n\t\t\t\t\t\t\t\t<el-button :type=\"jobStatusClass[job.status]\" size=\"mini\" class=\"pull-right m-r-md\">\n\t\t\t\t\t\t\t\t\t<i v-if=\"['pending'].includes(job.status)\" class=\"fa fa-circle-thin\"></i>\n\t\t\t\t\t\t\t\t\t<i v-if=\"['running'].includes(job.status)\" class=\"fa fa-spin fa-spinner\"></i>\n\t\t\t\t\t\t\t\t\t<i v-if=\"['finished'].includes(job.status)\" class=\"fa fa-check\"></i>\n\t\t\t\t\t\t\t\t\t{{ jobStatusText[job.status] }}\n\t\t\t\t\t\t\t\t</el-button>\n\t\t\t\t\t\t\t\t<el-button type=\"danger\" size=\"mini\" class=\"pull-right m-r-md\"\n\t\t\t\t\t\t\t\t\tv-if=\"['pending', 'running'].includes(job.status)\" @click.stop=\"onCancelJob(job.id)\">\n\t\t\t\t\t\t\t\t\t<i class=\"fa fa-remove\"></i>\n\t\t\t\t\t\t\t\t\t<span v-if=\"['pending'].includes(job.status)\">\n\t\t\t\t\t\t\t\t\t\t{{ $lang.buttons.cancel }}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t<span v-if=\"['running'].includes(job.status)\">\n\t\t\t\t\t\t\t\t\t\t{{ $lang.buttons.stop }}\n\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t</el-button>\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t\t<div v-loading=\"logLoading\" :element-loading-text=\"logLoadingText\">\n\t\t\t\t\t\t\t<pre>{{ logs[job.id] }}</pre>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</el-collapse-item>\n\t\t\t\t</el-collapse>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n</template>\n\n<script>\n\timport PanelTitle from '../../components/PanelTitle'\n\n\texport default {\n\t\tdata() {\n\t\t\treturn {\n\t\t\t\t// 连续获取错误次数\n\t\t\t\terrorCount: 0,\n\t\t\t\t// 所有项目\n\t\t\t\tprojects: [],\n\t\t\t\t// 加载projects标志\n\t\t\t\tprojectsLoading: true,\n\t\t\t\t// 所有爬虫 {'project1': ['spider1', 'spider2'], 'project2': ['spider1']}\n\t\t\t\tspiders: {},\n\t\t\t\t// 加载spiders标志\n\t\t\t\tspidersLoading: {},\n\t\t\t\t// 所有任务 {'project1': [{'id': '', 'spider': '', 'status': ''}]}\n\t\t\t\tjobs: {},\n\t\t\t\t// 任务状态\n\t\t\t\tjobStatuses: ['finished', 'running', 'pending'],\n\t\t\t\t// 任务状态class\n\t\t\t\tjobStatusClass: {\n\t\t\t\t\tfinished: 'info',\n\t\t\t\t\trunning: 'success',\n\t\t\t\t\tpending: 'warning'\n\t\t\t\t},\n\t\t\t\t// 任务状态文本\n\t\t\t\tjobStatusText: {\n\t\t\t\t\tfinished: this.$store.getters.$lang.buttons.finished,\n\t\t\t\t\trunning: this.$store.getters.$lang.buttons.running,\n\t\t\t\t\tpending: this.$store.getters.$lang.buttons.pending\n\t\t\t\t},\n\t\t\t\t// 任务信息 {'jobid': {'spider': 'spider1', 'project': 'project1'}}\n\t\t\t\tjobsInfo: {},\n\t\t\t\t// 日志信息 {'logid': 'text'}\n\t\t\t\tlogs: {},\n\t\t\t\t// 加载logs标志\n\t\t\t\tlogLoading: true,\n\t\t\t\t// 加载log提示语\n\t\t\t\tlogLoadingText: this.$store.getters.$lang.messages.loading,\n\t\t\t\t// 定时刷新log指针\n\t\t\t\tlogLoadingInterval: null,\n\t\t\t\t// 标记正在加载哪个log\n\t\t\t\tlogLoadingActive: null,\n\t\t\t\t// 路由信息\n\t\t\t\trouteId: this.$route.params.id\n\t\t\t}\n\t\t},\n\t\tcomponents: {\n\t\t\tPanelTitle,\n\t\t},\n\t\tcreated() {\n\t\t\tthis.getProjects()\n\t\t\tthis.$store.commit(\n\t\t\t\t'addInterval',\n\t\t\t\tsetInterval(() => {\n\t\t\t\t\tthis.getJobs()\n\t\t\t\t}, 5000)\n\t\t\t)\n\t\t},\n\t\tmethods: {\n\t\t\t//获取所有项目\n\t\t\tgetProjects() {\n\t\t\t\tthis.$http.get(this.formatString(this.$store.state.url.client.projects, {\n\t\t\t\t\tid: this.routeId\n\t\t\t\t})).then(({data: data}) => {\n\t\t\t\t\tthis.projects = data\n\t\t\t\t\tthis.projectsLoading = false\n\t\t\t\t\tthis.projects.forEach(project => {\n\t\t\t\t\t\tthis.$set(this.spidersLoading, project, true)\n\t\t\t\t\t})\n\t\t\t\t\tthis.errorCount = 0\n\t\t\t\t\t// 获取所有爬虫\n\t\t\t\t\tthis.getSpiders()\n\t\t\t\t\t// 获取所有任务\n\t\t\t\t\tthis.getJobs()\n\t\t\t\t}).catch(() => {\n\t\t\t\t\tthis.projectsLoading = false\n\t\t\t\t\tthis.errorCount += 1\n\t\t\t\t\tif (this.errorCount >= 3) {\n\t\t\t\t\t\tthis.$message.error(this.$store.getters.$lang.messages.errorLoad)\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// 定时任务\n\t\t\t\t\t\tthis.$store.commit(\n\t\t\t\t\t\t\t'setTimeout',\n\t\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\t\tthis.getProjects()\n\t\t\t\t\t\t\t}, 3000)\n\t\t\t\t\t\t)\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t},\n\t\t\t// 获取所有爬虫\n\t\t\tgetSpiders() {\n\t\t\t\tthis.projects.forEach(project => {\n\t\t\t\t\tthis.$http.get(this.formatString(this.$store.state.url.client.listSpiders, {\n\t\t\t\t\t\tid: this.routeId,\n\t\t\t\t\t\tproject: project\n\t\t\t\t\t})).then(({data: data}) => {\n\t\t\t\t\t\tthis.$set(this.spiders, project, data)\n\t\t\t\t\t\tthis.$set(this.spidersLoading, project, false)\n\t\t\t\t\t}).catch(() => {\n\t\t\t\t\t\tthis.$set(this.spidersLoading, project, false)\n\t\t\t\t\t})\n\t\t\t\t})\n\t\t\t},\n\t\t\t// 获取所有任务\n\t\t\tgetJobs() {\n\t\t\t\tthis.projects.forEach(project => {\n\t\t\t\t\tthis.$http.get(this.formatString(this.$store.state.url.client.listJobs, {\n\t\t\t\t\t\tid: this.routeId,\n\t\t\t\t\t\tproject: project\n\t\t\t\t\t})).then(({data: data}) => {\n\t\t\t\t\t\tthis.$set(this.jobs, project, data)\n\t\t\t\t\t\tfor (let project in this.jobs) {\n\t\t\t\t\t\t\tlet jobs = this.jobs[project]\n\t\t\t\t\t\t\tjobs.forEach(job => {\n\t\t\t\t\t\t\t\tthis.$set(this.jobsInfo, job.id, {\n\t\t\t\t\t\t\t\t\tproject: project,\n\t\t\t\t\t\t\t\t\tspider: job['spider']\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t})\n\t\t\t},\n\t\t\t// 启动任务\n\t\t\tonStartSpider(project, spider) {\n\t\t\t\tthis.$http.get(this.formatString(this.$store.state.url.client.startSpider, {\n\t\t\t\t\tid: this.routeId,\n\t\t\t\t\tproject: project,\n\t\t\t\t\tspider: spider\n\t\t\t\t})).then(() => {\n\t\t\t\t\tthis.$message.success(\n\t\t\t\t\t\tthis.$store.getters.$lang.messages.successRun\n\t\t\t\t\t)\n\t\t\t\t\tthis.getJobs()\n\t\t\t\t}).catch(() => {\n\t\t\t\t\tthis.$message.error(\n\t\t\t\t\t\tthis.$store.getters.$lang.messages.errorRun\n\t\t\t\t\t)\n\t\t\t\t})\n\t\t\t},\n\t\t\t// 获取日志\n\t\t\tgetLog(job) {\n\t\t\t\t// 如果展开日志\n\t\t\t\tif (job) {\n\t\t\t\t\t//设置活跃日志\n\t\t\t\t\tthis.logLoadingActive = job\n\t\t\t\t\t// 正在加载\n\t\t\t\t\tthis.logLoading = true\n\t\t\t\t\t// 请求日志\n\t\t\t\t\tthis.$http.get(this.formatString(this.$store.state.url.client.getLog, {\n\t\t\t\t\t\tid: this.routeId,\n\t\t\t\t\t\tproject: this.jobsInfo[this.logLoadingActive]['project'],\n\t\t\t\t\t\tspider: this.jobsInfo[this.logLoadingActive]['spider'],\n\t\t\t\t\t\tjob: this.logLoadingActive,\n\t\t\t\t\t\trandom: Math.random()\n\t\t\t\t\t})).then(({data: data}) => {\n\t\t\t\t\t\t//设置日志字典\n\t\t\t\t\t\tthis.$set(this.logs, this.logLoadingActive, data)\n\t\t\t\t\t\t// 加载日志完成\n\t\t\t\t\t\tthis.logLoading = false\n\t\t\t\t\t\t// 定时任务获取最新爬取日志\n\t\t\t\t\t\tthis.$store.commit(\n\t\t\t\t\t\t\t'setTimeout',\n\t\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\t\tthis.getLog(job)\n\t\t\t\t\t\t\t}, 2000)\n\t\t\t\t\t\t)\n\t\t\t\t\t}).catch(() => {\n\t\t\t\t\t\tthis.logLoading = false\n\t\t\t\t\t})\n\t\t\t\t} else {\n\t\t\t\t\t//闭合之后停止加载日志\n\t\t\t\t\tthis.$store.commit('clearTimeout')\n\t\t\t\t}\n\t\t\t},\n\t\t\tonCancelJob(job) {\n\t\t\t\tthis.$http.get(this.formatString(this.$store.state.url.client.cancelJob, {\n\t\t\t\t\tid: this.routeId,\n\t\t\t\t\tproject: this.jobsInfo[job]['project'],\n\t\t\t\t\tjob: job\n\t\t\t\t})).then(() => {\n\t\t\t\t\tthis.$message.success(\n\t\t\t\t\t\tthis.$store.getters.$lang.messages.canceling\n\t\t\t\t\t)\n\t\t\t\t\tthis.getJobs()\n\t\t\t\t}).catch(() => {\n\t\t\t\t\tthis.$message.error(\n\t\t\t\t\t\tthis.$store.getters.$lang.messages.errorCancel\n\t\t\t\t\t)\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\t}\n</script>\n\n<style>\n\t.el-collapse-item__content {\n\t\tpadding: 15px 15px;\n\t}\n</style>\n","\n.el-collapse-item__content {\n\tpadding: 15px 15px;\n}\n\n\n/*# sourceMappingURL=chunk-4a7237a2.1cb7792e.css.map*/"]}